name: CI - Test with minishell_tester

on:
  push:
    branches-ignore:
      - main
      - test

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          path: minishell
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone minishell_tester
        run: |
          git clone https://github.com/LucasKuhn/minishell_tester.git tester

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libreadline-dev libncurses-dev libtinfo-dev

      - name: Build minishell
        run: |
          cd minishell
          make -j$(nproc)

      - name: Run tester and capture results
        id: run_tests
        continue-on-error: true
        run: |
          cd tester
          # Link minishell binary to tester directory
          ln -sf ../minishell/minishell ./minishell
          
          # Run tester and capture output
          echo "## Minishell Tester Results" > test_report.md
          echo "" >> test_report.md
          echo "**Branch:** ${{ github.ref_name }}" >> test_report.md
          echo "**Commit:** ${{ github.sha }}" >> test_report.md
          echo "**Date:** $(date -u)" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
          
          # Run the tester (it may return non-zero if tests fail)
          ./tester 2>&1 | tee test_output.txt || true
          
          # Extract summary (passed/failed counts)
          cat test_output.txt >> test_report.md
          echo '```' >> test_report.md
          
          # Create summary - tester uses âœ… and âŒ emojis
          echo "" >> test_report.md
          echo "### Summary" >> test_report.md
          PASSED=$(grep -o 'âœ…' test_output.txt 2>/dev/null | wc -l || echo "0")
          FAILED=$(grep -o 'âŒ' test_output.txt 2>/dev/null | wc -l || echo "0")
          TOTAL=$((PASSED + FAILED))
          # Also extract the final score line (format: ok/total)
          SCORE=$(grep -E '^[0-9]+/[0-9]+' test_output.txt 2>/dev/null | tail -1 || echo "")
          echo "- âœ… Passed: $PASSED" >> test_report.md
          echo "- âŒ Failed: $FAILED" >> test_report.md
          echo "- ðŸ“Š Total: $TOTAL" >> test_report.md
          if [ -n "$SCORE" ]; then
            echo "- ðŸŽ¯ Score: $SCORE" >> test_report.md
          fi
          
          # Copy report to minishell directory
          cp test_report.md ../minishell/

      - name: Commit test report to branch
        run: |
          cd minishell
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if report exists
          if [ -f test_report.md ]; then
            git add test_report.md
            git commit -m "ðŸ“Š Test report for commit ${{ github.sha }}" || echo "No changes to commit"
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: Upload test report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: minishell/test_report.md

      - name: Show test summary
        run: |
          echo "=== TEST REPORT ==="
          cat minishell/test_report.md
