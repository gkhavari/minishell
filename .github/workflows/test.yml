name: CI - Test with minishell_tester

on:
  push:
    branches-ignore:
      - main
      - test

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clone minishell_tester inside project
        run: |
          git clone https://github.com/LucasKuhn/minishell_tester.git minishell_tester


      - name: Limit minishell runtime inside tester script
        run: |
          # Ensure each invocation of the tested minishell is bounded to avoid hangs
          sed -i 's/\$MINISHELL_PATH/timeout 10s \$MINISHELL_PATH/g' minishell_tester/tester || true
          # Verify the change
          head -n 40 minishell_tester/tester | sed -n '1,80p' || true
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libreadline-dev libncurses-dev libtinfo-dev

      - name: Build minishell
        run: |
          make -j$(nproc)

      - name: Run tester and capture results
        id: run_tests
        run: |
          cd minishell_tester
          
          # Run tester and capture output (tester looks for ../minishell binary)
          echo "## Minishell Tester Results" > test_report.md
          echo "" >> test_report.md
          echo "**Branch:** ${{ github.ref_name }}" >> test_report.md
          echo "**Commit:** ${{ github.sha }}" >> test_report.md
          echo "**Date:** $(date -u)" >> test_report.md
          echo "" >> test_report.md
          echo '```' >> test_report.md
            # Run the tester (it will return non-zero if tests fail)
            # Bound overall tester runtime to avoid hanging the job indefinitely
            timeout 15m ./tester 2>&1 | tee test_output.txt

            # Extract summary (passed/failed counts)
          cat test_output.txt >> test_report.md
          echo '```' >> test_report.md
          
          # Create summary - tester uses âœ… and âŒ emojis
          echo "" >> test_report.md
          echo "### Summary" >> test_report.md
          PASSED=$(grep -o 'âœ…' test_output.txt 2>/dev/null | wc -l || echo "0")
          FAILED=$(grep -o 'âŒ' test_output.txt 2>/dev/null | wc -l || echo "0")
          TOTAL=$((PASSED + FAILED))
          # Also extract the final score line (format: ok/total)
          SCORE=$(grep -E '^[0-9]+/[0-9]+' test_output.txt 2>/dev/null | tail -1 || echo "")
          echo "- âœ… Passed: $PASSED" >> test_report.md
          echo "- âŒ Failed: $FAILED" >> test_report.md
          echo "- ðŸ“Š Total: $TOTAL" >> test_report.md
          if [ -n "$SCORE" ]; then
            echo "- ðŸŽ¯ Score: $SCORE" >> test_report.md
          fi
          
          # Copy report to project root (for artifact upload)
          cp test_report.md ../



      - name: Upload test report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test_report.md

      - name: Show test summary
        if: always()
        run: |
          echo "=== TEST REPORT ==="
          cat test_report.md
